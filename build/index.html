<!DOCTYPE html>
<html lang="en">
<head >
    <title>test</title>

    <meta charset="utf-8">
    <link rel="stylesheet" href="assert/font-awesome-4.7.0/css/font-awesome.css">

    <!--<script src="assert/lib/d3.min.js"></script>-->
    <script src="assert/lib/cola.min.js"></script>
    <script src="assert/lib/dagre.js"></script>
    <script src="assert/lib/jquery.min.js"></script>
    <script src="js/klgraph.js"></script>

    <script src="assert/js/data.js"></script>
    <style>
        .fa{
            display: block;
            height:1px;
            color: rgba(0,0,0,0);
        }

        html , body{
            margin: 0px;
            width: 100%;
            height:100%;
        }
    </style>
</head>
<body>
<script type="x-shader/x-vertex" id="vert-shader">

 precision mediump float;
attribute float a_size;
attribute vec2 a_position;
attribute vec4 a_color;
attribute float a_img;
attribute vec2 a_uv;
attribute float a_selected;
attribute float a_flag;


uniform mat3 u_matrix;
uniform float u_camera_scale;
uniform float u_sample_ratio;

varying vec4 color;
varying float img;
varying float selected;
varying vec2 uv;
varying float flag;
varying float size;


void main() {

gl_Position = vec4((u_matrix*vec3(a_position,1)).xy,0,1);
color = a_color/255.0;
img = a_img;
selected = a_selected;
uv = a_uv;
flag = a_flag;

size = a_size / u_camera_scale ;
}

</script>
<script type="x-shader/x-vertex" id="frag-shader">
//#ifdef GL_OES_standard_derivatives
//#extension GL_OES_standard_derivatives : enable
//#endif

 precision mediump float;

varying vec4 color;
varying float img;
varying float selected;
varying vec2 uv;
varying float flag;
varying float size;


uniform sampler2D u_textures[10];
uniform sampler2D u_icons_texture;
uniform vec4 u_borderColor;
uniform float u_sample_ratio;

//todo
vec4 getSampleColore(int index,vec2 uv){
    vec4 c;
    if(index == 0){
        c = texture2D(u_textures[0],uv);
    }else if(index == 1){
        c = texture2D(u_textures[1],uv);
    }else if(index == 2){
        c = texture2D(u_textures[2],uv);
    }else if(index == 3){
        c = texture2D(u_textures[3],uv);
    }else if(index == 4){
        c = texture2D(u_textures[4],uv);
    }else if(index == 5){
        c = texture2D(u_textures[5],uv);
    }
    return c;
}

vec4 borderColor = u_borderColor/255.0;

void main()
{
   float r = 0.0, alpha = 1.0,
   blur = min(0.05,4.0/size) ,
   border = min(0.75,0.04*size) ;

if(flag > 0.5 && flag < 1.5) //flag =1 base
{
    vec4 nodecolor = color;
    vec2 cxy = 2.0 * uv - 1.0;
    r = length(cxy);

    if(r > 1.0 ){
        discard;
    }

    if(img >= 0.0){
        nodecolor = getSampleColore(int(img),uv);
    }

    if(r > 1.0-blur && r <=1.0){
        alpha = 1.0 - smoothstep(1.0-blur, 1.0, r);
     }


     if( selected > 0.5  && r > border && r < border + blur){
        nodecolor = mix(nodecolor,borderColor,smoothstep(border, border + blur, r));
    }

     if( selected > 0.5  &&  r >= border + blur){
        nodecolor = borderColor;
     }

      gl_FragColor = nodecolor * alpha;

}else if(flag > 1.5 && flag < 2.5) {//flag =2 icon
    gl_FragColor = texture2D(u_icons_texture,uv).w * vec4(1,1,1,1);
}


}

</script>
<!--<canvas id="canvas" style="width: 1000px;height: 800px;"></canvas>-->
<div id="canvas" style="width: 100%;height: 100%;"></div>
<i class="fa fa-university" style="transform: scale(0)"></i>
<script>

//    var colors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];
    var colors1 = [
        'rgba(51, 153, 131, 0.65)',
        'rgba(51, 118, 153, 0.65)',
        'rgba(80, 121, 187, 0.65)',
        'rgba(47, 40, 139,  0.65)',
    ];

    var colors = [
        '#397e9b',
        '#117b50',
        '#4cab9a',
        '#15757b',
    ];

    var g = {
        nodes:[],
        edges:[]
    };

    var canvas = document.getElementById('canvas');

    var N = 1000;

    var icons = ['\uf19c','\uf1a7','\uf19e','\uf1a0'];

    testData.data.nodes.forEach(function (e) {
        g.nodes.push({
//            img:Math.random() > 0.5 ? null : './img/eye-icon.png',
            type:Math.random() > 0.5 ?'default':'rect',
            flag:Math.random() > 0.5,
            id:e[0],
            label:e[1],
            x: (Math.random() * 2-1)*500,
            y: (Math.random() * 2-1)*400,
            size:16,
            width:12,
            height:6,
            color:colors[(Math.random()*colors.length)|0],
            icon:icons[(Math.random()*icons.length)|0],
        });
    })

    testData.data.relationships.forEach(function (e) {
        g.edges.push({
//            type:/*Math.random() > 0.5 ?'default':*/'curve',
//            type:'curve',
            dashed: Math.random() > 0.5 ,
            label:e[2],
            source:e[0],
            target:e[1],
            color:colors1[(Math.random()*colors1.length)|0],
        });
    })



//    for (var i = 0; i < N; i++) {
//        g.nodes.push({
////            img:Math.random() > 0.5 ? null : './img/eye-icon.png',
////            img:'./img/eye-icon.png',
//            type:Math.random() > 0.5 ?'default':'rect',
//            id:'node'+i,
//            label:'node'+i,
//            x: (Math.random() * 2-1)*500,
//            y: (Math.random() * 2-1)*400,
//            size:(Math.random())*10+5,
//            color:colors[(Math.random()*colors.length)|0],
//            icon:icons[(Math.random()*icons.length)|0],
//        });
//    }
//
//    for (var i = 0; i < N/2; i++) {
//        var sourceid =  (Math.random() * N) | 0;
//        var targetid =  (Math.random() * N) | 0;
//        if(sourceid != targetid){
//            g.edges.push({
//                id:'edge'+i,
//                type:Math.random() > 0.5 ?'default':'curve',
//                label:'edge'+i,
//                source:'node'+sourceid,
//                target:'node'+targetid
//            });
//        }
//
//    }

//    g.nodes = [
//        {id:'node1',label:'节点１', x:-200, y:0, size:15},
//        {id:'node2',label:'节点2', x:0, y:0, size:15},
////        {id:'node3',label:'节点2', x:(Math.random() * 2-1)*500, y:(Math.random() * 2-1)*500, size:50},
////        {id:'node4',label:'节点2', x:(Math.random() * 2-1)*500, y:(Math.random() * 2-1)*500, size:50},
//    ];
//
//    g.edges = [
//        {source:'node1',target:'node2',label:'curve1',type:'curve'},
//        {source:'node1',target:'node2',label:'curve2',type:'curve'},
//        {source:'node2',target:'node1',label:'curve3',type:'curve'}
//    ];



    var gview = new KLGraph.GraphView({
//        layout:'circular',
        nodes:g.nodes,
        edges:g.edges,
        container:canvas
    });

    gview.on('nodeclick',function (node,e) {
//        gview.graph.setNodeData(node.id,{selected:true});
        console.log(node);
//        console.log('nodeclick');
    });
    gview.on('stageclick',function (e) {
        console.log('stageclick');
    });

    document.addEventListener('keydown',function (e) {
        if(e.which == 46){
            gview.selection.delete();
        }
    })



//    test();

function test() {
    var comType = {
        FLOAT:{glType:'FLOAT',bytes:4},
        BYTE:{glType:'BYTE',bytes:1},
        SHORT:{glType:'SHORT',bytes:2},
        UNSIGNED_BYTE:{glType:'UNSIGNED_BYTE',bytes:1},
        UNSIGNED_SHORT:{glType:'UNSIGNED_SHORT',bytes:2},
    };

    var type = {
        FLOAT:{components:1,glType:'FLOAT'},
        FLOAT_VEC2:{components:2,glType:'FLOAT_VEC2'},
        FLOAT_VEC3:{components:3,glType:'FLOAT_VEC3'},
        FLOAT_VEC4:{components:4,glType:'FLOAT_VEC4'},
        INT:{components:1,glType:'INT'},
        INT_VEC2:{components:2,glType:'INT_VEC2'},
        INT_VEC3:{components:3,glType:'INT_VEC3'},
        INT_VEC4:{components:4,glType:'INT_VEC4'},
        BOOL:{components:1,glType:'BOOL'},
        BOOL_VEC2:{components:2,glType:'BOOL_VEC2'},
        BOOL_VEC3:{components:3,glType:'BOOL_VEC3'},
        BOOL_VEC4:{components:4,glType:'BOOL_VEC4'},
        FLOAT_MAT2:{components:4,glType:'FLOAT_MAT2'},
        FLOAT_MAT3:{components:9,glType:'FLOAT_MAT3'},
        FLOAT_MAT4:{components:16,glType:'FLOAT_MAT4'},
        SAMPLER_2D:{components:1,glType:'SAMPLER_2D'},
        SAMPLER_CUBE:{components:1,glType:'SAMPLER_CUBE'},
    }

    var config = {
        attr:{
            a_size:{type:type.FLOAT,comType:comType.FLOAT},
            a_position:{type:type.FLOAT_VEC2,comType:comType.FLOAT},
            a_color:{type:type.FLOAT_VEC4,comType:comType.UNSIGNED_BYTE}
        }
    }

//    var nodeDefault = new KLGraph.WebGLRender.node.default();
    var gl = gview.render.gl;
    var util = KLGraph.util;

    var vert = document.getElementById('vert-shader').textContent;
    var frag = document.getElementById('frag-shader').textContent;


    var program  = util.loadProgram(gl, [
        util.loadShader(gl, vert, gl.VERTEX_SHADER),
        util.loadShader(gl, frag, gl.FRAGMENT_SHADER)
    ]);


    var shaderAttrInfos = {};
    var numAttribs = gl.getProgramParameter(program, gl.ACTIVE_ATTRIBUTES);
    for (var i = 0; i < numAttribs; ++i) {
        var attribInfo = gl.getActiveAttrib(program, i);
        if (!attribInfo) {
            continue;
        }

        shaderAttrInfos[attribInfo.name] = {};
        shaderAttrInfos[attribInfo.name].type = attribInfo.type;
        shaderAttrInfos[attribInfo.name].size = attribInfo.size;
        shaderAttrInfos[attribInfo.name].location = gl.getAttribLocation(program, attribInfo.name);
    }


    var shaderUniformInfos = {};
    var numUniforms = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);
    for (var i = 0; i < numUniforms; ++i) {
        var uniformInfo = gl.getActiveUniform(program, i);
        if (!uniformInfo) {
            continue;
        }

        var name = uniformInfo.name;
        // remove the array suffix.
        if (name.substr(-3) === "[0]") {
            name = name.substr(0, name.length - 3);
        }

        shaderUniformInfos[name] = {};
        shaderUniformInfos[name].type = uniformInfo.type;
        shaderUniformInfos[name].size = uniformInfo.size;
        shaderUniformInfos[name].location = gl.getUniformLocation(program, name);
    }


    function getRenderData() {
        return {
            vbo: [
                {
                    a_size:{ value:1,bytes:4},
                    a_color:{ value:1,bytes:4},
                }
            ],
            ibo: []
        }
    }


}


</script>
</body>
</html>